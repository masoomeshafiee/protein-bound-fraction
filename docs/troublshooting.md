# Troubleshooting
This document outlines common setup and runtime issues, their likely causes, and suggested solutions.

## `file_name_handling.py`

| **Issue**                                        | **Possible Cause**                                                         | **Suggested Fix**                                                                                                  |
| ------------------------------------------------ | -------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| `ValueError: Mismatch in number of files...`     | The number of spot, track, and mask files don't match.                     | Ensure all spot, track, and mask files are present and follow the correct naming patterns and suffixes.            |
| Files not renamed, no changes in folder          | `dry_run=True` is enabled (default behavior).                              | Set `"dry_run": false` in the `config["path"]` section to actually rename the files.                               |
| `FileNotFoundError` when loading config          | The path provided to `--config` is incorrect or file does not exist.       | Make sure the `--config` path is correct and that the JSON file exists. Use an absolute path if unsure.            |
| Renamed files have unexpected names              | The `mask_suffix` is incorrect or doesn't match the actual mask filenames. | Check the mask file naming and adjust `mask_suffix` in the config to match the actual suffix used in your dataset. |
| Spot or track files not matched in correct order | Files are not naturally sorted.                                            | The script uses `natsort.natsorted` to address this. If still incorrect, ensure consistent and sortable filenames. |
| Accidentally renamed wrong files                 | `dry_run` was set to `false` without verifying output.                     | Always run with `dry_run=true` first to preview the changes. Backup your original files before actual renaming.    |



## `Pipeline.py`

| **Issue**                                                               | **Possible Cause**                                                                        | **Suggested Fix**                                                                                                                                  |
| ----------------------------------------------------------------------- | ----------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Config file not found: ...`                                            | The path provided to `--config` is incorrect or the file doesn't exist.                   | Check that the path to the config file is correct and the file exists. Use an absolute path if necessary.                                          |
| `Permission denied` when saving outputs                                 | The script is trying to write files in a directory without write permissions.             | Run the pipeline in a directory where you have write permissions, or change the `output_dir` in your config file to a writable location.           |
| `KeyError: 'output_config'`                                             | The required key is missing in the JSON config file.                                      | Double-check the structure of your config file and ensure it includes an `"output_config"` section with `"output_dir"` defined.                    |
| `ModuleNotFoundError` (e.g., `src.load_data`)                           | Relative imports fail or the `src/` directory is not in your Python path.                 | Ensure you're running the script from the root project directory (the one that contains `src/`). Alternatively, add the root to your `PYTHONPATH`. |
| Logging does not appear in terminal or file                             | The `setup_logging` function might not be called, or logs are overwritten.                | Make sure `setup_logging()` is called before any logging. Check `output_dir` for log files with correct timestamps.                                |
| Quality control plots not generated                                     | `quality_control` is set to `false` or necessary columns are missing.                     | Ensure `"quality_control": true` in the config, and that intensity and track length columns are correctly defined under `"columns_names"`.         |
| `ValueError` or `TypeError` during feature extraction or classification | Misconfigured or missing entries in `"columns_names"` or `"feature_extraction"` sections. | Ensure that column names in the config match the actual data and the expected schema.                                                              |
| `ValueError` in classification step                                     | Invalid `classification` config or no features to classify.                               | Double-check `feature_list` and `classification` settings. Ensure features were properly extracted.                                                |
| Final result files (e.g., `classified_tracks.csv`) not created          | An error occurred before the final write step.                                            | Check logs for exceptions, especially right before the saving step.                                                                                |
| `AttributeError: 'NoneType' object has no attribute ...`                | One of the intermediate steps returned `None` due to earlier failure.                     | Review the logs to trace where the pipeline stopped and fix the root cause.                                                                        |

## `load_data.py`
| **Issue**                                                            | **Possible Cause**                                                                                     | **Suggested Fix**                                                                                                                      |
| -------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------- |
| `ValueError: Path must be a dictionary...`                           | The `path` object passed to `load_data_from_config()` is not a dictionary or is missing required keys. | Ensure the config file contains a properly structured `"path"` dictionary with `"input_dir"`, `"masks_dir"`, and appropriate suffixes. |
| `ValueError: Invalid columns names format...`                        | The `columns_names` object is missing or has an incorrect format.                                      | Verify that `"columns_names"` exists in the config and that `"spots"` and `"tracks"` are lists of strings.                             |
| `FileNotFoundError: Input directory does not exist`                  | The `"input_dir"` path is incorrect or not created.                                                    | Make sure the input directory exists and the path is correct in the config. Use an absolute path if necessary.                         |
| `FileNotFoundError: Masks directory does not exist`                  | The `"masks_dir"` path is incorrect or the directory hasn't been created.                              | Verify the mask folder exists and the path is correct in the config.                                                                   |
| `Input directory is empty or does not contain files with suffix ...` | The directory exists but does not contain files matching the expected spot or track suffixes.          | Confirm the suffixes match the actual file names (e.g., `_spots.csv`, `_tracks.csv`) and that the files are in the right directory.    |
| `Masks directory is empty or does not contain files with suffix ...` | Mask files are missing or not correctly named.                                                         | Ensure all mask files exist and have the correct suffix (e.g., `_mask.png`).                                                           |
| `Missing spots data for ...`                                         | A track file was found for a cell, but the corresponding spot file is missing.                         | Check that each track file has a corresponding spot file with the same base name.                                                      |
| `Missing tracks data for ...`                                        | A spot file was found, but the corresponding track file is missing.                                    | Check that each spot file has a matching track file with the same base name.                                                           |
| `Mask file does not exist: ...`                                      | A spot/track pair exists, but the corresponding mask file is missing.                                  | Ensure that each spot/track file pair has a corresponding mask file named using the same base name.                                    |
| `Error loading data: ...`                                            | A general exception was raised while reading or validating the files.                                  | Review the error message in the logs. Check file formats, encodings, and ensure all required files are present and readable.           |
| `pandas.errors.ParserError` or malformed CSV                         | Spot or track file contains irregular formatting or delimiters.                                        | Check that CSVs are clean and comma-delimited with consistent rows. Open them in a text editor to inspect.                             |


## `Quality_control.py`
| **Issue**                                                                          | **Possible Cause**                                                        | **Suggested Fix**                                                                                                                              |
| ---------------------------------------------------------------------------------- | ------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| `FileNotFoundError` when saving plots                                              | The `intermediate_dir` does not exist or the path is incorrect.           | Ensure the directory exists or let the pipeline create it using `os.makedirs(intermediate_dir, exist_ok=True)` before plotting.                |
| Plots are not generated or saved                                                   | Data may be empty or contains only NaNs.                                  | Check that the input data (especially `track_duration` and `intensity` columns) contains valid numeric values. Also check the configuration for quality control plots.                                 |
| `KeyError: 'track_duration'` or `'intensity'`                                      | Required column is missing from the input DataFrame.                      | Ensure your data files include the correct column names as specified in the config (`columns_names`).                                          |
| `ValueError: zero-size array to reduction operation minimum which has no identity` | The input array to the plot function is empty.                            | Confirm that there are valid `track_duration` or `intensity` values in your dataset. |
| Gaussian fit looks incorrect                                                       | Data distribution is skewed, sparse, or non-Gaussian.                     | This is expected for some datasets. You can disable Gaussian fitting by setting `fit_gaussian=False`.                                          |
| Overwritten or missing plot files                                                  | File naming conflicts from multiple runs.                                 | Use timestamped or uniquely named output files to prevent overwriting if needed.                                                               |
| Y-axis is unclear (e.g., density vs. count)                                        | `density` and `fit_gaussian` flags are mismatched or misleading.          | Set `density=False` for count-based plots and `fit_gaussian=True` only if using `density=True`.                                                |
| X-axis range too narrow or wide                                                    | Default x-limits may not be appropriate for all datasets.                 | Customize `xlim` argument or remove it for auto-scaling.                                                                                       |

## `filter_data.py`

| **Issue**                                                       | **Possible Cause**                                                                  | **Suggested Fix**                                                                                                                                                |
| --------------------------------------------------------------- | ----------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `"No data found after filtering. Please check the input data."` | All files were excluded due to validation failure or filtering criteria. | Verify that your input files contain valid data and mask.                                          |
| `"No tracks found after filtering by length..."`                | `track_duration` values are too short for the configured threshold.                 | Check the distribution of `track_duration` in your raw data by setting the config[quality_control]=ture. Adjust `min_track_duration` to a lower value if needed.                                             |
| `"No tracks found within the cells in the mask..."`             | Tracks lie outside labeled mask regions or the mask is incorrect.                   | Visually inspect your masks and track coordinates. Ensure spatial alignment and correct segmentation. 
| `"No corresponding spots found for the filtered tracks..."`     | Spots corresponding to retained tracks were missing or mislinked.                   | Check that the `track_id` column is consistent between spots and tracks.                         |
| `"No cells found after filtering by mask and length..."`        | All cells in the mask were excluded due to empty filtered tracks or spots.          | Ensure that at least some cells contain valid tracks above threshold. verify the mask quality.                     |
| Filtered result contains no spots or tracks | Mismatches between `track_id` in spots vs tracks, misaligned coordinates, or incorrect column names | Ensure that `track_id` values in `spots` match those retained in filtered `tracks`. Verify `columns_names` in your config file are spelled exactly like in your CSV headers. Also check that `(x_loc, y_loc)` values fall within mask bounds and match image resolution. |
| `KeyError: 'x_loc' or 'y_loc'`                                  | The required spatial coordinate columns are missing from tracks.                    | Confirm that `x_loc` and `y_loc` are present in the `columns_names['tracks']` and in the actual data.                                                            |
| `filter_tracks_by_mask()` returns empty DataFrame unexpectedly  | All tracks fall outside mask boundaries or mask is mislabeled (all zero).           | Visualize both the mask and track positions for one sample to confirm proper overlap.                                                                            |                                          |
| `TypeError` or `KeyError` during filtering                      | Unexpected structure in input data or config.                                       | Validate the config and ensure that each `file_data` dictionary contains `spots`, `tracks`, and `mask` keys, and their corresponding values are of correct type. |
| Filtered result contains no spots or tracks                     | Data-matching logic is faulty. See table below.                     | Inspect intermediate filtered tracks and check how many are removed at each stage.                                                                               |
| Empty `issue_dict` despite failures                             | `log_issue()` might not be triggered or validation skipped.                         | Make sure validation is always performed at the start of `filter_population_level` or `filter_single_cell_level`. Check logging levels and message logic.        |

#### Data-matching logic


| Component                                      | What should match                                                                   | What could go wrong                                                                                                            |
| ---------------------------------------------- | ----------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------ |
| `spots` and `tracks`                           | `track_id` column in `spots` should match `track_id` in `tracks`                    | Some `track_id`s in `spots` no longer exist after track filtering, or mismatched formatting (e.g., float vs int)               |
| `tracks` and `mask`                            | `(x_loc, y_loc)` of each track should fall within a labeled cell region in the mask | Track coordinates might be outside mask bounds or misaligned due to differing image origins, resolution, or coordinate systems |
| `columns_names` in config vs actual data       | Config must define all expected columns exactly as they appear in CSVs              | Misspelled or missing columns lead to KeyErrors or validation failures                                                         |

## `feature_extraction.py`
| **Issue**                                                           | **Possible Cause**                                                                   | **Suggested Fix**                                                                                                                               |
| ------------------------------------------------------------------- | ------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| `"The filtered_data is empty or not a dictionary."`                 | Data was not passed correctly from the filtering step, or the structure was altered. | Make sure `filter_tracks_and_spots()` successfully returned non-empty filtered data before calling `extract_features()`.                        |
| `"Unsupported features requested and ignored: [...]"`               | The `feature_list` in the config contains unimplemented features.                    | Currently, only `"radius_of_gyration"` is supported. Remove or comment out other entries in the config under `feature_extraction.feature_list`. |
| `"No spots data found in the data block."`                          | Missing or incorrectly structured input in `filtered_data`.                          | Check that each data block includes a `'spots'` key with a valid DataFrame. This likely indicates a failure during filtering.                   |
| `"invalid spot structure: ..."`                                     | Missing required columns like `x_loc`, `y_loc`, or `track_id`.                       | Ensure your spot DataFrame includes all columns specified in `columns_names['spots']` in the config file.                                                          |
| `log_rg` column is NaN or contains `-inf`                           | The radius of gyration is 0 (or nearly 0), leading to `log(0)` or `log(very small)`. | This may happen with very short or static tracks. Filter out such tracks before feature extraction.  |
| `"No valid tracks found for radius of gyration calculation."`       | The grouped tracks didn't meet the criteria for analysis or contain no variation.    | Inspect whether `track_id` grouping results in empty or degenerate groups (e.g., single-spot tracks).                                           |
| `Error calculating radius of gyration: ...`                         | Unexpected numerical or logic error inside `extract_rg()` (e.g., NaNs, wrong dtype). | Check for NaN values in `x_loc`, `y_loc`. You may need to filter them before applying the radius calculation.                                   |
| Returned DataFrame is empty after feature extraction                | All cells or files were skipped due to invalid/missing data.                         | Review the `intermediate_results/issues.csv` for detailed reasons. Check config consistency.           |
| `KeyError` on `x_loc`, `y_loc`, or `track_id`                       | Column names in your data don't match those in the config.                           | Double-check your CSV headers and the `columns_names['spots']` configuration. Ensure they match exactly (case-sensitive and order-sensitive).                       |
| Radius of gyration values are unexpectedly low or high              | Track coordinates may not be in physical units (e.g., micrometers).                  | Ensure your coordinates are scaled correctly. If they're in pixels, convert to micrometers if needed before applying radius calculation.        |


## `motion_classifier.py`
| **Issue**                                                              | **Possible Cause**                                                                      | **Suggested Fix**                                                                                                                                |
| ---------------------------------------------------------------------- | --------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
| `"log_rg" column not found in processed_data.`                         | The feature extraction step failed or was skipped, resulting in missing input features. | Make sure `extract_features()` was run and returned a valid DataFrame. Check that `feature_list` includes `"radius_of_gyration"`.                |
| `ValueError: Input DataFrame must contain log_rg column.`              | `assign_classes()` called without verifying input.                                      | Confirm `processed_data` contains `'log_rg'`.                                                |
| `Threshold between components could not be computed` (logged warning)  | Gaussians have overlapping or nearly identical means, making root-finding unstable.     | This is non-fatal. The fallback midpoint will be used. Consider reducing `n_components` or inspecting `log_rg` distribution.                     |
| All tracks assigned as `"uncertain"`                                   | GMM confidence threshold is too high, or GMM components are poorly separated.           | Lower `classification_config['confidence_level']` (e.g., 0.7). Also visually inspect histogram and GMM fits.                                     |
| `"Missing feature column: 'log_rg'"` or similar                        | Wrong feature name is passed in the config or to `assign_classes()`.   o r the previous step (feature_extraction) failed.                 | Ensure `classification_config['feature_to_classify'] == 'log_rg'`.                                                                               |
| Plot not saved / `FileNotFoundError`                                   | `output_config['output_dir']` or filename is invalid or not created beforehand.         | Ensure `output_dir` exists, or wrap `os.makedirs()` before calling save.                                                                         |
| `gmm_fit()` returns overlapping or implausible components              | The data is too uniform, sparse, or has outliers.                                       | screen `log_rg` distribution. Consider filtering out extreme values.                 |
| `plot_classification_results()` fails with `KeyError` in plot settings | Missing keys in `plot_config['plot_settings']` dict.                                    | Ensure it contains `title`, `xlabel`, `ylabel`, `bins`, `hist_color`, `hist_label`, `title_fontsize`, and `label_fontsize`.                      || `ValueError: Expected GMM with X components, but got Y.`               | The loaded GMM model does not match `n_components` specified in the config.             | Ensure the model at `classification_config['gmm_model_path']` was trained with the same `n_components`. Re-train the model if necessary.         || `FileNotFoundError: [Errno 2] No such file or directory` when loading GMM | The `gmm_model_path` is incorrect or the file doesn't exist.                            | Verify the path in `classification_config['gmm_model_path']`. Use an absolute path or ensure the file was saved in a prior run.                  |
| `EOFError` or `UnpicklingError` when loading GMM model                 | The GMM model file is corrupted or was saved with an incompatible Python/Joblib version.| Re-train and re-save the model using a compatible environment. Avoid modifying the `.joblib` file manually.                                      |


## `save_metadata.py`
| **Issue**                                                                                                        | **Possible Cause**                                                          | **Suggested Fix**                                                                                                                                   |
| ---------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Failed to save config: [Errno ...]`                                                                             | The output directory is not writable or `config` is not JSON serializable.  | Check if `out_dir` is valid and writable. Ensure `config` contains only serializable types (e.g., no functions or file handles).                    |
| `Failed to save pip environment: [Errno ...]` or `FileNotFoundError: [Errno 2] No such file or directory: 'pip'` | `pip` is not available in the execution environment or subprocess failed.   | Make sure Python and pip are correctly installed and accessible in your environment. Try running `pip freeze` manually.                             |
| Output files are missing despite no error                                                                        | Metadata files were saved in a different directory or overwritten silently. | Confirm the value of `out_dir` in config file. |
| Special characters in config cause save failure                                                                  | Non-UTF8 characters or binary values in config                              | Ensure the config dictionary contains only standard strings or clean Unicode data.                                                                  |

# Debugging Tips
- Use logging messages to trace the pipeline step-by-step.
- Add print() or pdb.set_trace() for in-depth inspection.
- Try running each module (e.g., run_preprocess.py) independently.

#  Still stuck?
Feel free to open an issue on GitHub with:
- The error message
- A description of what you were trying to do
- Your config.json (if not sensitive)
- Screenshot or logs





